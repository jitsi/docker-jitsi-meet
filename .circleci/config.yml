version: 2.1

orbs:
  codecov: codecov/codecov@1.0.2
  aws-ecr: circleci/aws-ecr@9.7.0
  aws-ecs: circleci/aws-ecs@4.0.0
  aws-cli: circleci/aws-cli@4.0

executors:
  big-machine:
    machine:
      image: ubuntu-2004:2023.07.1
    resource_class: large   # or xlarge if you have it

workflows:
  deployment:
    jobs:
      - aws-ecr/build_and_push_image:
          name: dev-ecr-build-push-app
          account_id: ${AWS_ACCOUNT_ID}
          auth:
              - aws-cli/setup:
                  role_arn: arn:aws:iam::233718569638:role/stella-circleci
          dockerfile: Dockerfile
          executor: big-machine
          path: web
          build_path: web
          repo: portal-dev-jitsi-web
          tag: 'latest,$CIRCLE_SHA1'
          pre-steps:
            - checkout
            - run:
                name: Init & update git submodules
                command: |
                  git submodule sync --recursive
                  git submodule update --init --recursive
          filters:
            branches:
              only:
                - develop
      - aws-ecr/build_and_push_image:
          name: dev-ecr-build-push-prosody
          account_id: ${AWS_ACCOUNT_ID}
          auth:
              - aws-cli/setup:
                  role_arn: arn:aws:iam::233718569638:role/stella-circleci
          dockerfile: Dockerfile
          path: prosody
          build_path: prosody
          repo: portal-dev-jitsi-prosody
          tag: 'latest,$CIRCLE_SHA1'
          filters:
            branches:
              only:
                - develop
      - aws-ecr/build_and_push_image:
          name: prod-ecr-build-push-app
          account_id: ${AWS_ACCOUNT_ID}
          auth:
              - aws-cli/setup:
                  role_arn: arn:aws:iam::233718569638:role/stella-circleci
          dockerfile: Dockerfile
          path: web
          build_path: web
          repo: portal-prod-jitsi-web
          tag: 'latest,$CIRCLE_SHA1'
          executor: big-machine
          pre-steps:
            - checkout
            - run:
                name: Init & update git submodules
                command: |
                  git submodule sync --recursive
                  git submodule update --init --recursive
          filters:
            branches:
              only:
                - master
      - aws-ecr/build_and_push_image:
          name: prod-ecr-build-push-prosody
          account_id: ${AWS_ACCOUNT_ID}
          auth:
              - aws-cli/setup:
                  role_arn: arn:aws:iam::233718569638:role/stella-circleci
          dockerfile: Dockerfile
          path: prosody
          build_path: prosody
          repo: portal-prod-jitsi-prosody
          tag: 'latest,$CIRCLE_SHA1'
          filters:
            branches:
              only:
                - master
      - aws-ecs/deploy_service_update:
          name: 'dev-app-deployment'
          auth:
            - aws-cli/setup:
                role_arn: arn:aws:iam::233718569638:role/stella-circleci
          cluster: 'stella-dev'
          family: 'portal-dev-jitsi'
          container_image_name_updates: container=web,tag=${CIRCLE_SHA1}
          service_name: 'jitsi'
          force_new_deployment: true
          requires:
            - dev-ecr-build-push-app
          filters:
            branches:
              only:
                - develop
      - aws-ecs/deploy_service_update:
          name: 'dev-prosody-deployment'
          auth:
            - aws-cli/setup:
                role_arn: arn:aws:iam::233718569638:role/stella-circleci
          cluster: 'stella-dev'
          family: 'portal-dev-jitsi'
          container_image_name_updates: container=prosody,tag=${CIRCLE_SHA1}
          service_name: 'jitsi'
          force_new_deployment: true
          requires:
            - dev-ecr-build-push-prosody
          filters:
            branches:
              only:
                - develop
      - aws-ecs/deploy_service_update:
          name: 'prod-app-deployment'
          auth:
            - aws-cli/setup:
                role_arn: arn:aws:iam::233718569638:role/stella-circleci
          cluster: 'stella-prod'
          family: 'portal-prod-jitsi'
          container_image_name_updates: container=web,tag=${CIRCLE_SHA1}
          service_name: 'jitsi'
          force_new_deployment: true
          requires:
            - prod-ecr-build-push-app
          filters:
            branches:
              only:
                - master
      - aws-ecs/deploy_service_update:
          name: 'prod-prosody-deployment'
          auth:
            - aws-cli/setup:
                role_arn: arn:aws:iam::233718569638:role/stella-circleci
          cluster: 'stella-prod'
          family: 'portal-prod-jitsi'
          container_image_name_updates: container=prosody,tag=${CIRCLE_SHA1}
          service_name: 'jitsi'
          force_new_deployment: true
          requires:
            - prod-ecr-build-push-prosody
          filters:
            branches:
              only:
                - master